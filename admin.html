<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Pizzaria Santa Sensa√ß√£o</title>
    <meta name="description" content="Painel administrativo da Pizzaria Santa Sensa√ß√£o">
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-body">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Conectando com o banco de dados...</p>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-logo">
                    <i class="fas fa-pizza-slice"></i>
                    <h2>Santa Sensa√ß√£o</h2>
                </div>
                <div class="access-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>‚ö†Ô∏è ACESSO RESTRITO ‚ö†Ô∏è</p>
                    <small>Apenas administradores autorizados</small>
                </div>
            </div>

            <form id="adminLoginForm" class="login-form">
                <div class="form-group">
                    <label for="adminEmail">Email de Administrador</label>
                    <input type="email" id="adminEmail" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword">Senha</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <div id="loginError" class="error-message" style="display: none;"></div>
                <button type="submit" class="btn btn--primary" id="loginSubmitBtn">
                    <span class="btn-text">Entrar</span>
                    <span class="btn-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Entrando...
                    </span>
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-panel" style="display: none;">
        <!-- Header -->
        <header class="admin-header">
            <div class="admin-header-content">
                <div class="admin-logo">
                    <i class="fas fa-pizza-slice"></i>
                    <span>Santa Sensa√ß√£o - Admin</span>
                </div>
                <div class="admin-user">
                    <span id="adminUserName">Administrador</span>
                    <button id="logoutBtn" class="btn btn--outline">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="admin-tabs">
            <button class="tab-btn active" data-tab="dashboard">
                <i class="fas fa-chart-pie"></i>
                Dashboard
            </button>
            <button class="tab-btn" data-tab="menu">
                <i class="fas fa-utensils"></i>
                Gerenciar Card√°pio
            </button>
            <button class="tab-btn" data-tab="users">
                <i class="fas fa-users"></i>
                Clientes Cadastrados
            </button>
            <button class="tab-btn" data-tab="settings">
                <i class="fas fa-cog"></i>
                Configura√ß√µes
            </button>
        </nav>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-icon">
                        <i class="fas fa-pizza-slice"></i>
                    </div>
                    <div class="card-content">
                        <h3 id="totalItems">-</h3>
                        <p>Itens do Card√°pio</p>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="card-content">
                        <h3 id="totalUsers">-</h3>
                        <p>Clientes Cadastrados</p>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon">
                        <i class="fas fa-list"></i>
                    </div>
                    <div class="card-content">
                        <h3 id="totalCategories">-</h3>
                        <p>Categorias</p>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="card-content">
                        <h3 id="lastActivity">-</h3>
                        <p>√öltima Atividade</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Menu Management Tab -->
        <div id="menuTab" class="tab-content">
            <div class="tab-header">
                <h2>Gerenciar Card√°pio</h2>
                <div class="tab-actions">
                    <button class="btn btn--primary" id="addCategoryBtn">
                        <i class="fas fa-plus"></i> Nova Categoria
                    </button>
                    <button class="btn btn--secondary" id="addItemBtn">
                        <i class="fas fa-plus"></i> Novo Item
                    </button>
                </div>
            </div>

            <!-- Menu Categories -->
            <div class="menu-section">
                <h3>Categorias</h3>
                <div id="categoriesList" class="categories-grid">
                    <!-- Categories will be loaded here -->
                </div>
            </div>

            <!-- Menu Items -->
            <div class="menu-section">
                <h3>Itens do Card√°pio</h3>
                <div class="menu-filters">
                    <select id="categoryFilter">
                        <option value="">Todas as categorias</option>
                    </select>
                    <input type="search" id="itemSearch" placeholder="Buscar item...">
                </div>
                <div id="menuItemsList" class="menu-items-grid">
                    <!-- Menu items will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="usersTab" class="tab-content">
            <div class="tab-header">
                <h2>Clientes Cadastrados</h2>
                <button class="btn btn--primary" id="addUserBtn">
                    <i class="fas fa-plus"></i> Novo Cliente
                </button>
            </div>
            <div id="usersList" class="users-list">
                <!-- Users will be loaded here -->
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content">
            <div class="tab-header">
                <h2>Configura√ß√µes</h2>
            </div>
            <div class="settings-grid">
                <div class="settings-card">
                    <h3>Informa√ß√µes da Pizzaria</h3>
                    <form id="businessInfoForm">
                        <div class="form-group">
                            <label>Nome</label>
                            <input type="text" id="businessName" value="Pizzaria Santa Sensa√ß√£o">
                        </div>
                        <div class="form-group">
                            <label>Slogan</label>
                            <input type="text" id="businessSlogan" value="A pizza n¬∫ 1 do ES üèÖ">
                        </div>
                        <div class="form-group">
                            <label>Endere√ßo</label>
                            <textarea id="businessAddress">Porfilio Furtado, 178, Centro - Santa Leopoldina, ES</textarea>
                        </div>
                        <div class="form-group">
                            <label>Telefone/WhatsApp</label>
                            <input type="tel" id="businessPhone" value="+5527996500341">
                        </div>
                        <div class="form-group">
                            <label>Hor√°rio de Funcionamento</label>
                            <input type="text" id="businessHours" value="De quarta a domingo a partir das 19h">
                        </div>
                        <button type="submit" class="btn btn--primary">Salvar Altera√ß√µes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="categoryModalTitle">Nova Categoria</h3>
                <button class="close-btn" id="closeCategoryModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="categoryForm">
                <div class="form-group">
                    <label for="categoryName">Nome da Categoria</label>
                    <input type="text" id="categoryName" required>
                </div>
                <div class="form-group">
                    <label for="categoryDescription">Descri√ß√£o</label>
                    <textarea id="categoryDescription"></textarea>
                </div>
                <div class="form-group">
                    <label for="categoryOrder">Ordem</label>
                    <input type="number" id="categoryOrder" min="1">
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="categoryActive" checked>
                        <span>Categoria ativa</span>
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn--outline" id="cancelCategoryBtn">Cancelar</button>
                    <button type="submit" class="btn btn--primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Item Modal -->
    <div id="itemModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 id="itemModalTitle">Novo Item</h3>
                <button class="close-btn" id="closeItemModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="itemForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="itemName">Nome do Item</label>
                        <input type="text" id="itemName" required>
                    </div>
                    <div class="form-group">
                        <label for="itemCategory">Categoria</label>
                        <select id="itemCategory" required>
                            <option value="">Selecione uma categoria</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="itemDescription">Descri√ß√£o</label>
                    <textarea id="itemDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label>Pre√ßos por Tamanho</label>
                    <div class="price-inputs">
                        <div class="price-input">
                            <label>Pequena (P)</label>
                            <input type="number" id="priceP" step="0.01" min="0">
                        </div>
                        <div class="price-input">
                            <label>M√©dia (M)</label>
                            <input type="number" id="priceM" step="0.01" min="0">
                        </div>
                        <div class="price-input">
                            <label>Grande (G)</label>
                            <input type="number" id="priceG" step="0.01" min="0">
                        </div>
                        <div class="price-input">
                            <label>√önica</label>
                            <input type="number" id="priceUnica" step="0.01" min="0">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="itemImage">URL da Imagem</label>
                        <input type="url" id="itemImage">
                    </div>
                    <div class="form-group">
                        <label for="itemOrder">Ordem de Exibi√ß√£o</label>
                        <input type="number" id="itemOrder" min="1">
                    </div>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="itemAvailable" checked>
                        <span>Item dispon√≠vel</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="itemPopular">
                        <span>Item popular</span>
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn--outline" id="cancelItemBtn">Cancelar</button>
                    <button type="submit" class="btn btn--primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Admin App Script -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAWVI9VHvxARMSM3JV-bXs_73UjKh25mn4",
            authDomain: "thebaldi-me.firebaseapp.com",
            projectId: "thebaldi-me",
            storageBucket: "thebaldi-me.firebasestorage.app",
            messagingSenderId: "794996190135",
            appId: "1:794996190135:web:444f87525f52d79c7d5632"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Admin Panel Management
        class AdminPanel {
            constructor() {
                this.currentAdmin = null;
                this.currentEditingCategory = null;
                this.currentEditingItem = null;
                this.init();
            }

            async init() {
                this.showLoading();
                this.setupEventListeners();

                // Check if admin is already logged in
                const savedAdmin = localStorage.getItem('santa_sensacao_admin');
                if (savedAdmin) {
                    this.currentAdmin = JSON.parse(savedAdmin);
                    this.showAdminPanel();
                    this.loadDashboard();
                } else {
                    this.hideLoading();
                    this.showLoginModal();
                }
            }

            setupEventListeners() {
                // Login form
                document.getElementById('adminLoginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });

                // Logout
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    this.logout();
                });

                // Tab navigation
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.switchTab(btn.dataset.tab);
                    });
                });

                // Modal controls
                this.setupModalControls();

                // Form handlers
                this.setupFormHandlers();
            }

            setupModalControls() {
                // Category modal
                document.getElementById('addCategoryBtn').addEventListener('click', () => {
                    this.openCategoryModal();
                });
                document.getElementById('closeCategoryModal').addEventListener('click', () => {
                    this.closeCategoryModal();
                });
                document.getElementById('cancelCategoryBtn').addEventListener('click', () => {
                    this.closeCategoryModal();
                });

                // Item modal
                document.getElementById('addItemBtn').addEventListener('click', () => {
                    this.openItemModal();
                });
                document.getElementById('closeItemModal').addEventListener('click', () => {
                    this.closeItemModal();
                });
                document.getElementById('cancelItemBtn').addEventListener('click', () => {
                    this.closeItemModal();
                });
            }

            setupFormHandlers() {
                document.getElementById('categoryForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveCategory();
                });

                document.getElementById('itemForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveItem();
                });
            }

            async handleLogin() {
                const email = document.getElementById('adminEmail').value.trim();
                const password = document.getElementById('adminPassword').value;
                const errorDiv = document.getElementById('loginError');
                const submitBtn = document.getElementById('loginSubmitBtn');

                this.toggleButtonLoading(submitBtn, true);
                errorDiv.style.display = 'none';

                try {
    // Busca o documento do admin na cole√ß√£o 'portfolio_users'
    const adminDoc = await db.collection('portfolio_users').doc(email).get();

    if (!adminDoc.exists) {
        throw new Error('Usu√°rio administrador n√£o encontrado.');
    }

    const adminData = adminDoc.data();

    // Compara a senha digitada com a senha no banco de dados
    if (password === adminData.password) {
        this.currentAdmin = { email: adminData.email, name: adminData.name || 'Administrador' };
        localStorage.setItem('santa_sensacao_admin', JSON.stringify(this.currentAdmin));

        // Log de login bem-sucedido
        await this.logActivity('admin_login', email, { success: true });

        this.showAdminPanel();
        this.loadDashboard();
        this.showToast('Login realizado com sucesso!', 'success');
    } else {
        throw new Error('Email ou senha incorretos');
    }
} catch (error) {
    console.error('Login error:', error);
    errorDiv.textContent = error.message;
    errorDiv.style.display = 'block';

    // Log de tentativa de login falha
    await this.logActivity('admin_login_failed', email, { error: error.message });
} finally {
    this.toggleButtonLoading(submitBtn, false);
}
            }

            logout() {
                localStorage.removeItem('santa_sensacao_admin');
                this.currentAdmin = null;
                document.getElementById('adminPanel').style.display = 'none';
                this.showLoginModal();
                this.showToast('Logout realizado com sucesso!', 'info');
            }

            showLoading() {
                document.getElementById('loadingScreen').style.display = 'flex';
            }

            hideLoading() {
                document.getElementById('loadingScreen').style.display = 'none';
            }

            showLoginModal() {
                document.getElementById('loginModal').style.display = 'flex';
            }

            hideLoginModal() {
                document.getElementById('loginModal').style.display = 'none';
            }

            showAdminPanel() {
                this.hideLoading();
                this.hideLoginModal();
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('adminUserName').textContent = this.currentAdmin.name;
            }

            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}Tab`).classList.add('active');

                // Load tab-specific content
                switch(tabName) {
                    case 'dashboard':
                        this.loadDashboard();
                        break;
                    case 'menu':
                        this.loadMenuManagement();
                        break;
                    case 'users':
                        this.loadUsers();
                        break;
                    case 'settings':
                        this.loadSettings();
                        break;
                }
            }

            async loadDashboard() {
                try {
                    // Load statistics
                    const [categoriesSnap, itemsSnap, usersSnap, logsSnap] = await Promise.all([
                        db.collection('menu_categories').get(),
                        db.collection('menu_items').get(),
                        db.collection('portfolio_users').get(),
                        db.collection('system_logs').orderBy('timestamp', 'desc').limit(1).get()
                    ]);

                    document.getElementById('totalCategories').textContent = categoriesSnap.size;
                    document.getElementById('totalItems').textContent = itemsSnap.size;
                    document.getElementById('totalUsers').textContent = usersSnap.size;

                    if (!logsSnap.empty) {
                        const lastLog = logsSnap.docs[0].data();
                        const lastActivity = new Date(lastLog.timestamp).toLocaleDateString('pt-BR');
                        document.getElementById('lastActivity').textContent = lastActivity;
                    }
                } catch (error) {
                    console.error('Error loading dashboard:', error);
                    this.showToast('Erro ao carregar dashboard', 'error');
                }
            }

            async loadMenuManagement() {
                await this.loadCategories();
                await this.loadMenuItems();
            }

            async loadCategories() {
                try {
                    const categoriesSnap = await db.collection('menu_categories').orderBy('order').get();
                    const categoriesList = document.getElementById('categoriesList');
                    categoriesList.innerHTML = '';

                    categoriesSnap.forEach(doc => {
                        const category = { id: doc.id, ...doc.data() };
                        const categoryElement = this.createCategoryElement(category);
                        categoriesList.appendChild(categoryElement);
                    });
                } catch (error) {
                    console.error('Error loading categories:', error);
                    this.showToast('Erro ao carregar categorias', 'error');
                }
            }

            async loadMenuItems() {
                try {
                    const itemsSnap = await db.collection('menu_items').orderBy('displayOrder').get();
                    const itemsList = document.getElementById('menuItemsList');
                    itemsList.innerHTML = '';

                    itemsSnap.forEach(doc => {
                        const item = { id: doc.id, ...doc.data() };
                        const itemElement = this.createItemElement(item);
                        itemsList.appendChild(itemElement);
                    });
                } catch (error) {
                    console.error('Error loading menu items:', error);
                    this.showToast('Erro ao carregar itens do menu', 'error');
                }
            }

            createCategoryElement(category) {
                const div = document.createElement('div');
                div.className = 'category-card';
                div.innerHTML = `
                    <div class="category-info">
                        <h4>${category.name}</h4>
                        <p>${category.description || ''}</p>
                        <div class="category-status">
                            <span class="status ${category.active ? 'active' : 'inactive'}">
                                ${category.active ? 'Ativo' : 'Inativo'}
                            </span>
                        </div>
                    </div>
                    <div class="category-actions">
                        <button class="btn btn--small btn--outline" onclick="adminPanel.editCategory('${category.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn--small btn--danger" onclick="adminPanel.deleteCategory('${category.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                return div;
            }

            createItemElement(item) {
                const div = document.createElement('div');
                div.className = 'menu-item-card';

                const prices = Object.entries(item.prices || {})
                    .map(([size, price]) => `${size}: R$ ${price.toFixed(2)}`)
                    .join(', ');

                div.innerHTML = `
                    <div class="item-info">
                        <h4>${item.name}</h4>
                        <p>${item.description}</p>
                        <div class="item-details">
                            <span class="prices">${prices}</span>
                            <div class="item-badges">
                                ${item.isAvailable ? '<span class="badge available">Dispon√≠vel</span>' : '<span class="badge unavailable">Indispon√≠vel</span>'}
                                ${item.popular ? '<span class="badge popular">Popular</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn--small btn--outline" onclick="adminPanel.editItem('${item.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn--small btn--danger" onclick="adminPanel.deleteItem('${item.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                return div;
            }

            // Category Management
            openCategoryModal(categoryId = null) {
                this.currentEditingCategory = categoryId;
                const modal = document.getElementById('categoryModal');
                const title = document.getElementById('categoryModalTitle');
                const form = document.getElementById('categoryForm');

                if (categoryId) {
                    title.textContent = 'Editar Categoria';
                    this.loadCategoryData(categoryId);
                } else {
                    title.textContent = 'Nova Categoria';
                    form.reset();
                    document.getElementById('categoryActive').checked = true;
                }

                modal.style.display = 'flex';
            }

            closeCategoryModal() {
                document.getElementById('categoryModal').style.display = 'none';
                this.currentEditingCategory = null;
            }

            async loadCategoryData(categoryId) {
                try {
                    const doc = await db.collection('menu_categories').doc(categoryId).get();
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('categoryName').value = data.name;
                        document.getElementById('categoryDescription').value = data.description || '';
                        document.getElementById('categoryOrder').value = data.order || 1;
                        document.getElementById('categoryActive').checked = data.active !== false;
                    }
                } catch (error) {
                    console.error('Error loading category:', error);
                    this.showToast('Erro ao carregar dados da categoria', 'error');
                }
            }

            async saveCategory() {
                const name = document.getElementById('categoryName').value.trim();
                const description = document.getElementById('categoryDescription').value.trim();
                const order = parseInt(document.getElementById('categoryOrder').value) || 1;
                const active = document.getElementById('categoryActive').checked;

                if (!name) {
                    this.showToast('Nome da categoria √© obrigat√≥rio', 'error');
                    return;
                }

                try {
                    const categoryData = {
                        name,
                        description,
                        order,
                        active,
                        updatedAt: new Date().toISOString()
                    };

                    if (this.currentEditingCategory) {
                        await db.collection('menu_categories').doc(this.currentEditingCategory).update(categoryData);
                        await this.logActivity('category_updated', this.currentAdmin.email, { categoryId: this.currentEditingCategory, name });
                        this.showToast('Categoria atualizada com sucesso!', 'success');
                    } else {
                        categoryData.createdAt = new Date().toISOString();
                        const docRef = await db.collection('menu_categories').add(categoryData);
                        await this.logActivity('category_created', this.currentAdmin.email, { categoryId: docRef.id, name });
                        this.showToast('Categoria criada com sucesso!', 'success');
                    }

                    this.closeCategoryModal();
                    this.loadCategories();
                } catch (error) {
                    console.error('Error saving category:', error);
                    this.showToast('Erro ao salvar categoria', 'error');
                }
            }

            // Item Management
            openItemModal(itemId = null) {
                this.currentEditingItem = itemId;
                const modal = document.getElementById('itemModal');
                const title = document.getElementById('itemModalTitle');
                const form = document.getElementById('itemForm');

                if (itemId) {
                    title.textContent = 'Editar Item';
                    this.loadItemData(itemId);
                } else {
                    title.textContent = 'Novo Item';
                    form.reset();
                    document.getElementById('itemAvailable').checked = true;
                }

                this.loadCategoryOptions();
                modal.style.display = 'flex';
            }

            closeItemModal() {
                document.getElementById('itemModal').style.display = 'none';
                this.currentEditingItem = null;
            }

            async loadCategoryOptions() {
                try {
                    const categoriesSnap = await db.collection('menu_categories').where('active', '==', true).get();
                    const select = document.getElementById('itemCategory');

                    // Clear existing options except the first one
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }

                    categoriesSnap.forEach(doc => {
                        const category = doc.data();
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = category.name;
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading category options:', error);
                }
            }

            async loadItemData(itemId) {
                try {
                    const doc = await db.collection('menu_items').doc(itemId).get();
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('itemName').value = data.name;
                        document.getElementById('itemDescription').value = data.description;
                        document.getElementById('itemCategory').value = data.categoryId;
                        document.getElementById('itemImage').value = data.imageUrl || '';
                        document.getElementById('itemOrder').value = data.displayOrder || 1;
                        document.getElementById('itemAvailable').checked = data.isAvailable !== false;
                        document.getElementById('itemPopular').checked = data.popular === true;

                        // Load prices
                        if (data.prices) {
                            document.getElementById('priceP').value = data.prices.P || '';
                            document.getElementById('priceM').value = data.prices.M || '';
                            document.getElementById('priceG').value = data.prices.G || '';
                            document.getElementById('priceUnica').value = data.prices.√önica || data.prices.unica || '';
                        }
                    }
                } catch (error) {
                    console.error('Error loading item:', error);
                    this.showToast('Erro ao carregar dados do item', 'error');
                }
            }

            async saveItem() {
                const name = document.getElementById('itemName').value.trim();
                const description = document.getElementById('itemDescription').value.trim();
                const categoryId = document.getElementById('itemCategory').value;
                const imageUrl = document.getElementById('itemImage').value.trim();
                const displayOrder = parseInt(document.getElementById('itemOrder').value) || 1;
                const isAvailable = document.getElementById('itemAvailable').checked;
                const popular = document.getElementById('itemPopular').checked;

                if (!name || !description || !categoryId) {
                    this.showToast('Nome, descri√ß√£o e categoria s√£o obrigat√≥rios', 'error');
                    return;
                }

                // Build prices object
                const prices = {};
                const priceP = parseFloat(document.getElementById('priceP').value);
                const priceM = parseFloat(document.getElementById('priceM').value);
                const priceG = parseFloat(document.getElementById('priceG').value);
                const priceUnica = parseFloat(document.getElementById('priceUnica').value);

                if (!isNaN(priceP)) prices.P = priceP;
                if (!isNaN(priceM)) prices.M = priceM;
                if (!isNaN(priceG)) prices.G = priceG;
                if (!isNaN(priceUnica)) prices.√önica = priceUnica;

                if (Object.keys(prices).length === 0) {
                    this.showToast('Pelo menos um pre√ßo deve ser definido', 'error');
                    return;
                }

                try {
                    const itemData = {
                        name,
                        description,
                        categoryId,
                        prices,
                        imageUrl,
                        displayOrder,
                        isAvailable,
                        popular,
                        updatedAt: new Date().toISOString()
                    };

                    if (this.currentEditingItem) {
                        await db.collection('menu_items').doc(this.currentEditingItem).update(itemData);
                        await this.logActivity('item_updated', this.currentAdmin.email, { itemId: this.currentEditingItem, name });
                        this.showToast('Item atualizado com sucesso!', 'success');
                    } else {
                        itemData.createdAt = new Date().toISOString();
                        const docRef = await db.collection('menu_items').add(itemData);
                        await this.logActivity('item_created', this.currentAdmin.email, { itemId: docRef.id, name });
                        this.showToast('Item criado com sucesso!', 'success');
                    }

                    this.closeItemModal();
                    this.loadMenuItems();
                } catch (error) {
                    console.error('Error saving item:', error);
                    this.showToast('Erro ao salvar item', 'error');
                }
            }

            // Delete functions
            async editCategory(categoryId) {
                this.openCategoryModal(categoryId);
            }

            async deleteCategory(categoryId) {
                if (!confirm('Tem certeza que deseja excluir esta categoria? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }

                try {
                    await db.collection('menu_categories').doc(categoryId).delete();
                    await this.logActivity('category_deleted', this.currentAdmin.email, { categoryId });
                    this.showToast('Categoria exclu√≠da com sucesso!', 'success');
                    this.loadCategories();
                } catch (error) {
                    console.error('Error deleting category:', error);
                    this.showToast('Erro ao excluir categoria', 'error');
                }
            }

            async editItem(itemId) {
                this.openItemModal(itemId);
            }

            async deleteItem(itemId) {
                if (!confirm('Tem certeza que deseja excluir este item? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }

                try {
                    await db.collection('menu_items').doc(itemId).delete();
                    await this.logActivity('item_deleted', this.currentAdmin.email, { itemId });
                    this.showToast('Item exclu√≠do com sucesso!', 'success');
                    this.loadMenuItems();
                } catch (error) {
                    console.error('Error deleting item:', error);
                    this.showToast('Erro ao excluir item', 'error');
                }
            }

            // Users management (simplified for now)
            async loadUsers() {
                try {
                    const usersSnap = await db.collection('portfolio_users').get();
                    const usersList = document.getElementById('usersList');
                    usersList.innerHTML = '';

                    if (usersSnap.empty) {
                        usersList.innerHTML = '<p class="empty-state">Nenhum cliente cadastrado ainda.</p>';
                        return;
                    }

                    usersSnap.forEach(doc => {
                        const user = { id: doc.id, ...doc.data() };
                        const userElement = this.createUserElement(user);
                        usersList.appendChild(userElement);
                    });
                } catch (error) {
                    console.error('Error loading users:', error);
                    this.showToast('Erro ao carregar usu√°rios', 'error');
                }
            }

            createUserElement(user) {
                const div = document.createElement('div');
                div.className = 'user-card';

                const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString('pt-BR') : 'N/A';

                div.innerHTML = `
                    <div class="user-info">
                        <h4>${user.name || 'Nome n√£o informado'}</h4>
                        <p>Email: ${user.email}</p>
                        <p>Cadastrado em: ${createdAt}</p>
                        ${user.isFirstLogin ? '<span class="badge warning">Primeiro login pendente</span>' : '<span class="badge success">Ativo</span>'}
                    </div>
                    <div class="user-actions">
                        <button class="btn btn--small btn--outline" onclick="adminPanel.editUser('${user.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                `;
                return div;
            }

            async editUser(userId) {
                // Simplified user editing - just show info for now
                this.showToast('Edi√ß√£o de usu√°rios ser√° implementada em breve', 'info');
            }

            // Settings management
            async loadSettings() {
                // Settings are loaded from the form default values
                // Could be extended to load from database
            }

            // Utility functions
            toggleButtonLoading(button, isLoading) {
                const btnText = button.querySelector('.btn-text');
                const btnLoading = button.querySelector('.btn-loading');

                if (isLoading) {
                    btnText.style.display = 'none';
                    btnLoading.style.display = 'inline';
                    button.disabled = true;
                } else {
                    btnText.style.display = 'inline';
                    btnLoading.style.display = 'none';
                    button.disabled = false;
                }
            }

            showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast toast--${type}`;
                toast.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                `;

                toastContainer.appendChild(toast);

                // Auto remove after 3 seconds
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            async logActivity(action, user, details = {}) {
                try {
                    await db.collection('system_logs').add({
                        action,
                        user,
                        details,
                        timestamp: new Date().toISOString()
                    });
                } catch (error) {
                    console.error('Error logging activity:', error);
                }
            }
        }

        // Initialize Admin Panel
        const adminPanel = new AdminPanel();
    </script>
</body>
</html>